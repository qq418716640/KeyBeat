# KeyBeat — 情侣键盘心跳 Chrome 扩展设计方案

> 监听键盘敲击活跃度，情侣配对后实时查看对方状态，用颜色直观表达"对方在忙"。

---

## 一、核心概念

**KeyBeat**（键盘心跳）—— 把键盘敲击频率抽象为一个"心跳"，让伴侣感知到对方此刻的电脑使用状态。

- 不记录具体按键内容（隐私安全）
- 只统计敲击频率和活跃度
- 用颜色直觉化表达状态

---

## 二、用户角色与流程

### 2.1 注册/登录

- 支持邮箱 + 密码注册
- 可选：Google OAuth 第三方登录
- 登录后进入个人面板

### 2.2 配对流程（一对一）

```
用户A（发起方）                     用户B（接受方）
    |                                   |
    |-- 1. 点击"生成配对密钥" -------->  |
    |   （生成一个唯一密钥字符串）        |
    |                                   |
    |-- 2. 将密钥分享给B ------------>  |
    |   （复制/二维码/链接）             |
    |                                   |
    |                   3. B输入密钥 ---|
    |                   点击"绑定"      |
    |                                   |
    |<-- 4. 双方确认绑定 ------------->  |
    |   （A收到通知，确认后绑定成功）     |
    |                                   |
    |<========= 配对完成 =============>  |
```

**密钥规则：**
- 格式：`KB-XXXX-XXXX-XXXX`（12位随机字母数字）
- 一次只能绑定一个人
- 密钥使用一次后失效
- 有效期：生成后 24 小时内未使用则过期
- 解绑需双方任一方操作，解绑后密钥作废

### 2.3 解绑

- 任何一方可主动解绑
- 解绑后双方数据不再同步
- 解绑后可重新生成密钥配对新伴侣

---

## 三、分数系统设计

### 3.1 数据采集

- **监听范围**：浏览器内所有标签页的键盘按下事件（`keydown`）
- **不记录**：具体按键值、输入内容、所在网页
- **只记录**：每分钟的按键总次数（聚合后上报）

### 3.2 时间窗口

采用**滚动时间窗口**，统计最近 30 分钟的活跃度：

| 时间窗口 | 说明 |
|----------|------|
| 最近 5 分钟 | 实时状态权重最高 |
| 最近 15 分钟 | 中期活跃度 |
| 最近 30 分钟 | 整体趋势 |

### 3.3 分数计算

```
活跃分 = (近5分钟按键数 × 0.6) + (近15分钟按键数 × 0.3) + (近30分钟按键数 × 0.1)
```

将原始分数映射到 **0-100** 分区间：

| 分数区间 | 状态 | 颜色 | 含义 |
|----------|------|------|------|
| 0 | 离线/未活跃 | ⚫ 灰色 `#9E9E9E` | 不在电脑前 |
| 1-20 | 低活跃 | 🔵 蓝色 `#42A5F5` | 偶尔点一下 |
| 21-50 | 中等活跃 | 🟢 绿色 `#66BB6A` | 正常使用中 |
| 51-80 | 高活跃 | 🟠 橙色 `#FFA726` | 忙碌打字中 |
| 81-100 | 极高活跃 | 🔴 红色 `#EF5350` | 疯狂输出中 |

### 3.4 数据上报频率

- 本地每 **10 秒** 聚合一次按键计数
- 每 **1 分钟** 向服务器上报一次
- 拉取对方状态：每 **30 秒** 轮询一次（或使用 WebSocket 推送）

---

## 四、界面设计

### 4.1 扩展图标（Browser Action）

- 扩展图标本身用颜色反映**对方的状态**
- 未配对时显示灰色图标
- 配对后图标颜色随对方分数动态变化

### 4.2 弹出面板（Popup）

```
┌──────────────────────────────┐
│  KeyBeat ♥                   │
├──────────────────────────────┤
│                              │
│  我的状态                     │
│  ██████████░░░░  62分        │
│  🟠 忙碌打字中                │
│                              │
├──────────────────────────────┤
│                              │
│  TA的状态                     │
│  ████████████░░  78分        │
│  🟠 忙碌打字中                │
│  最后更新：30秒前             │
│                              │
├──────────────────────────────┤
│  [今日活跃趋势图 - 折线图]    │
│  显示双方24小时活跃曲线       │
│                              │
├──────────────────────────────┤
│  ⚙️ 设置  |  🔗 配对管理      │
└──────────────────────────────┘
```

### 4.3 设置页面

- 开启/关闭监听
- 隐私模式（暂停上报，显示为离线）
- 解绑配对
- 退出登录

---

## 五、技术架构

### 5.1 前端（Chrome 扩展）

```
chrome-extension/
├── manifest.json          # Manifest V3 配置
├── background.js          # Service Worker（核心逻辑）
│   ├── 按键计数聚合
│   ├── 定时上报
│   └── 定时拉取对方状态
├── content.js             # Content Script（注入页面监听键盘事件）
├── popup/
│   ├── popup.html         # 弹出面板
│   ├── popup.js           # 面板逻辑
│   └── popup.css          # 样式
├── options/
│   ├── options.html       # 设置/配对管理页面
│   └── options.js
├── auth/
│   ├── login.html         # 登录页
│   └── register.html      # 注册页
└── assets/
    └── icons/             # 各状态颜色图标
```

### 5.2 后端 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/auth/register` | POST | 注册 |
| `/auth/login` | POST | 登录，返回 JWT |
| `/pair/generate` | POST | 生成配对密钥 |
| `/pair/bind` | POST | 输入密钥绑定 |
| `/pair/confirm` | POST | 发起方确认绑定 |
| `/pair/unbind` | POST | 解绑 |
| `/pair/status` | GET | 获取配对状态 |
| `/score/report` | POST | 上报自己的分数 |
| `/score/partner` | GET | 获取对方最新分数 |
| `/score/history` | GET | 获取双方历史趋势（24h） |

### 5.3 数据模型

**用户表 (users)**
```
id, email, password_hash, nickname, created_at
```

**配对表 (pairs)**
```
id, user_a_id, user_b_id, pair_key, status(pending/active/unbound), created_at
```

**分数记录表 (scores)**
```
id, user_id, score, keycount_5min, keycount_15min, keycount_30min, recorded_at
```

### 5.4 技术选型建议

| 层 | 方案 |
|----|------|
| 后端 | Node.js + Express 或 Python + FastAPI |
| 数据库 | PostgreSQL 或 MySQL |
| 缓存 | Redis（缓存最新分数，减轻 DB 压力） |
| 实时推送 | WebSocket（推荐）或 SSE |
| 认证 | JWT |
| 部署 | 云服务器 / Vercel + Supabase |

---

## 六、隐私与安全

### 6.1 隐私保护

- **绝不记录按键内容**，只记录按键次数
- **绝不记录用户浏览的网址**
- 本地聚合后再上报，服务器只收到数字
- 用户可随时暂停监听（隐私模式）
- 用户可随时删除账号和所有数据

### 6.2 安全措施

- 密码 bcrypt 加盐哈希存储
- API 通信全程 HTTPS
- JWT Token 带过期时间
- 配对密钥一次性使用，24h 过期
- 防刷：限制上报频率（Rate Limiting）

### 6.3 Chrome Web Store 合规

- 权限只申请必要的（无需 `<all_urls>`）
- 提供清晰的隐私政策
- 明确说明数据收集范围（仅按键次数）
- 符合 Manifest V3 规范

---

## 七、MVP 开发优先级

### P0 — 核心功能（第一版）

1. 用户注册/登录
2. 键盘敲击监听与本地计数
3. 配对密钥生成与绑定
4. 分数计算与上报
5. 查看对方分数（颜色展示）
6. Popup 面板基本 UI

### P1 — 体验优化

7. 扩展图标动态变色
8. 24小时趋势折线图
9. 隐私模式（暂停上报）
10. 解绑功能

### P2 — 未来扩展

11. 消息提醒（对方上线/离线通知）
12. 自定义颜色主题
13. 每日/每周活跃报告
14. 心情状态手动设置（搭配自动检测）

---

## 八、待确认事项

- [ ] 产品名称确认（KeyBeat / 其他）
- [ ] 后端技术栈确认
- [ ] 是否需要手机端配套（小程序/App）
- [ ] 是否支持 Google OAuth 登录
- [ ] 部署方案确认（自建服务器 / BaaS 服务）
